<html lang="fr-FR";>
<head>
<meta  charset=UTF-8">
</head>
<body>
<div id="chart-container">
<p id="AffichageAlarm" style="text-align:left;  font-size: 0.875em;"></p>
<style type="text/css">
p {color:#ff2222; font-size: 0.875em; }
</style>

<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>

<script type="text/javascript">
	
var max_elements_table = 100;
var table_alarm [];


//=============================== TitreMoulinsart =================================//
var site = "arthur";
var room = "Moulinsart";
var channel_id = 809574;
var api_key = '2WTHUAZL6YMI175Y';

//================================================================================//

//***********************************************************************************//


//======================================= 4D  ===================================//

var DaysAlarmDisplay = 4;	// Alarm period to be displayed

//======================================= 1M  ===================================//

//var DaysAlarmDisplay = 31;	// Alarm period to be displayed

//======================================= 6M  ==================================//

//var DaysAlarmDisplay = 184;	// Alarm period to be displayed

//***********************************************************************************//

var TexteTitre;

var date_last_update;

var MinutesTemp;

var MinutesWorking;

// user's timezone offset
var my_offset = new Date().getTimezoneOffset();

var data;

var TexteTitreTrie;



$.getJSON( 'https://api.thingspeak.com/channels/' + channel_id + '/fields/1/last.json?api_key=' + api_key, function(data) {

var value = data["field1"];
if (value !== null)
{
	date_last_update = new Date(data.created_at);
	var date_last_alarm_millis = Date.parse (date_last_update);
	var date_today = new Date(Date.now());
	var date_today_millis =  Date.parse (date_today);
	var date_alarm_limit_millis = date_today_millis - (DaysAlarmDisplay * 86400000);
	var date_alarm_limit = new Date (date_alarm_limit_millis);
	
	if (date_last_alarm_millis > (date_alarm_limit_millis))
	{

		$.getJSON( 'https://api.thingspeak.com/channels/' + channel_id + '/fields/1.json?api_key=' + api_key + '&start=' + date_alarm_limit + '&end=' + date_last_update, function(data) {
			TexteTitreTrie = "<span style=\" font-family: Arial, Helvetica, sans-serif; text-align:center; color:#ff2222; \" ><h1>Alarmes</h1></span><span style=\" font-family: Arial, Helvetica, sans-serif; text-align:center; color:#ff2222; \" ><font size=\"2\"><table>";
			
			// iterate through each feed
			$.each(data.feeds, function() 
			{
				
				var value = this["field1"];

				if (value !== null)
				{
					date_last_update = new Date(this.created_at);
					TexteTitre += "<tr><td>";
					var options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
					
					TexteTitre += "</span><span style=\" font-size:0.8em; font-family: Arial, Helvetica, sans-serif; text-align:left; color:#ff2222; \" >";
					TexteTitre += date_last_update.toLocaleDateString('fr-FR',options);
					TexteTitre += " ";  
					TexteTitre += date_last_update.getHours();
					TexteTitre += ":";
					MinutesWorking = date_last_update.getMinutes();
					if (MinutesWorking < 10) {MinutesTemp = '0'; MinutesTemp += MinutesWorking;}
					else {MinutesTemp = MinutesWorking;}
					TexteTitre += MinutesTemp;
					TexteTitre += "  &nbsp;&nbsp;&nbsp; </td><td> ";
					TexteTitre += "<font size=\"2\">";
					TexteTitre += value;
					TexteTitre += "</td></tr>";
					table_alarm.unshift(TexteTitre);
				}

				
			} )
			
			for (var i = 0; i < table_alarm.length; i++) 
			{
			TexteTitreTrie += table_alarm[i];
			}
			TexteTitreTrie += "</table></span></p>";	
			document.getElementById("AffichageAlarm").innerHTML = TexteTitreTrie;

			
		}	);
	}
}
})

</script>
</div>
</body>
</html>