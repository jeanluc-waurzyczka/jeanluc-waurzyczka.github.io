<html lang="fr-FR";>
<head>
<meta  charset=UTF-8">
</head>
<body>
<div id="chart-container">
<p id="AffichageAlarm" style="text-align:left; color:#ff2222;"></p>
<style type="text/css">
{ background-color: white; height: 100%; margin: 0; padding: 0;}
a { text-decoration:none;}
#chart-container {  display: block; position:absolute; bottom:0; top:0; left:0; right:0; margin: 5px 15px 15px 0; overflow: hidden; }
</style>

<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>

<script type="text/javascript">


//=============================== TitreMoulinsart =================================//
var site = "arthur";
var room = "Moulinsart";
var channel_id = 809574;
var api_key = '2WTHUAZL6YMI175Y';

//================================================================================//

//***********************************************************************************//


//======================================= 4D  ===================================//

//var DaysAlarmDisplay = 4;	// Alarm period to be displayed

//======================================= 1M  ===================================//

//var DaysAlarmDisplay = 31;	// Alarm period to be displayed

//======================================= 6M  ==================================//

var DaysAlarmDisplay = 184;	// Alarm period to be displayed

//***********************************************************************************//

var TexteTitre;

var date_last_update;

var MinutesTemp;

var MinutesWorking;

// user's timezone offset
var my_offset = new Date().getTimezoneOffset();

var data;



$.getJSON( 'https://api.thingspeak.com/channels/' + channel_id + '/fields/1/last.json?api_key=' + api_key, function(data) {

var value = data["field1"];
if (value !== null)
{
	date_last_update = new Date(data.created_at);
	var date_last_alarm_millis = Date.parse (date_last_update);
	var date_today = new Date(Date.now());
	var date_today_millis =  Date.parse (date_today);
	var date_alarm_limit_millis = date_today_millis - (DaysAlarmDisplay * 86400000);
	var date_alarm_limit = new Date (date_alarm_limit_millis);
	
	if (date_last_alarm_millis > (date_alarm_limit_millis))
	{

		$.getJSON( 'https://api.thingspeak.com/channels/' + channel_id + '/fields/1.json?api_key=' + api_key + '&start=' + date_alarm_limit + '&end=' + date_last_update, function(data) {
			TexteTitre = "<span style=\"font-size:0.8em; font-family: Arial, Helvetica, sans-serif; text-align:left; color:#ff2222;\" ><Alarm<table><tr><td></td><td>Alarmes</td></tr>";
			
			// iterate through each feed
			$.each(data.feeds, function() 
			{
				
				var value = this["field1"];

				if (value !== null)
				{
					date_last_update = new Date(this.created_at);
					TexteTitre += "<tr><td>";
					var options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
					TexteTitre += date_last_update.toLocaleDateString('fr-FR',options);
					TexteTitre += " ";  
					TexteTitre += date_last_update.getHours();
					TexteTitre += ":";
					MinutesWorking = date_last_update.getMinutes();
					if (MinutesWorking < 10) {MinutesTemp = '0'; MinutesTemp += MinutesWorking;}
					else {MinutesTemp = MinutesWorking;}
					TexteTitre += MinutesTemp;
					TexteTitre += " </td><td> ";
					TexteTitre += value;
					TexteTitre += "</td></tr>";
				}

				
			} )
			
			TexteTitre += "</table></span></p>";	
			document.getElementById("AffichageAlarm").innerHTML = TexteTitre;

			
		}	);
	}
}
})

</script>
</div>
</body>
</html>