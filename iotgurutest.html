<html lang="fr-FR";>
<head>
<meta  charset=UTF-8">
</head>
<body>
<div id="chart-container">
<p id="AffichageTitre" style="text-align:center; color:#040457;"></p>
<style type="text/css">
{ background-color: white; height: 100%; margin: 0; padding: 0;}
a { text-decoration:none;}
#chart-container { width: 100%; height: 55px; display: block; position:absolute; bottom:0; top:0; left:0; right:0; margin: 5px 15px 15px 0; overflow: hidden; }
</style>

<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<script type="text/javascript">


//=========================== TitreCampingCar ==============================//
var site = "campingcar";
var room = "Camping-Car";
var channel_id = 901544;
var api_key = 'Z996IH7IT3K2DHQ2';


//============================================== Test Atelier JL =======================================================//
var DeviceShortId = 'ssbN5XnOFjPOG-JwJikR6g';
var DeviceKey = 'jDy2YhGGVqPbRrxg_fhKeA';
var DHT22NodeShortId = 'ssbN5XnOFjPkXEuwJikR6g';
var DHT22NodeKey = 'kLfpkfHoA3mUXPHYVJRPuA';
var MQ135NodeShortId = 'uK-Ls4AXTQ70cZMgJikR6g';
var MQ135NodeKey = 'pcDXKnx5e0WFRUjqOVZFzQ';

//================================================================================//


var TexteTitre = "<a target=\"_top\" href=\"https://am-jl.jimdo.com/";
var TexteTitre1 = "/\"><strong>";
var TexteTitre2 = "</strong></a> </span><span style=\"font-size:1.125em;\"> { ";
var TexteTitre3 = ":";
var TexteTitre4 = " }</p>";

var date_last_update;

var MinutesTemp;

var MinutesWorking;

var data;


function loadData(target, titleText, xAxisText, yAxisText, nodeId, fieldName, granulation) {
	return $.ajax({
            type: "GET",
            url: 'https://api.iotguru.cloud/measurement/loadByNodeId/' + nodeId + '/' + fieldName + '/' + granulation,
            dataType: "json",
            success: function (data)
                        {
                           processData(target, titleText, xAxisText, yAxisText, granulation, data);
                        }
	});
}


//==================================================== deviceFind ======================================================//


function deviceFind(deviceId) {


	$.ajax({
type: "GET",
url: '//api.iotguru.live/device/find/' + deviceId,
dataType: "json",
	beforeSend: function (xhr) {
			var accessToken =  Cookies.get('accessToken');
			if (accessToken) {
				xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
			}
},
success: function (data) {
			deviceFindResponse(data);
		},
error: function (xhr) {
			deviceFindError(xhr);
		}
	});
}



function deviceFindError(xhr) {
	TexteTitre = 'Error IoTGuru';
	document.getElementById("AffichageTitre").innerHTML = TexteTitre;
}

function deviceFindResponse(data) {

	TexteTitre += site;
	TexteTitre += TexteTitre1;
	TexteTitre += data.description;

//	TexteTitre += " | ip ";
//	TexteTitre += data.ip;
	TexteTitre += " | devID: ";
TexteTitre += data.deviceId;

	TexteTitre += " | reportedFirmwareVersion: ";
	TexteTitre += data.reportedFirmwareVersion;
	TexteTitre += TexteTitre2;
	TexteTitre += data.lastCheck;
	TexteTitre += TexteTitre4;
	document.getElementById("AffichageTitre").innerHTML = TexteTitre;

}	;

    function fluentDuration(timestamp) {
        if (!timestamp) {
            return 'n/a';
        }

        var totalSeconds = ~~((new Date().getTime() - timestamp) / 1000);
        var days = ~~(totalSeconds / 86400);
        var hours = ~~((totalSeconds % 86400) / 3600);
        var minutes = ~~((totalSeconds % 3600) / 60);
        var seconds = ~~(totalSeconds % 60);

        var message = [];
        if (days > 0) {
            message.push(' ');
            message.push(days);
            message.push(' ');
            if (days > 1) {
                message.push('days');
            } else {
                message.push('day');
            }
            message.push(' ');
            message.push(hours);
            message.push(' ');
            if (hours > 1) {
                message.push('hours');
            } else {
                message.push('hour');
            }
        } else if (hours > 0) {
            message.push(' ');
            message.push(hours);
            message.push(' ');
            if (hours > 1) {
                message.push('hours');
            } else {
                message.push('hour');
            }
            message.push(' ');
            message.push(minutes);
            message.push(' ');
            if (minutes > 1) {
                message.push('minutes');
            } else {
                message.push('minute');
            }
        } else {
            message.push(' ');
            message.push(minutes);
            message.push(' ');
            if (minutes > 1) {
                message.push('minutes');
            } else {
                message.push('minute');
            }
            message.push(' ');
            message.push(seconds);
            message.push(' ');
            if (seconds > 1) {
                message.push('seconds');
            } else {
                message.push('second');
            }
        }

        return message.join('');
    }
    

//======================================================================================================================//
//																								//
//									C R E D E N T I A L												//
//																								//
//======================================================================================================================//

//============================================== credentialAccessToken =================================================//

function credentialAccessToken(successCallback, errorCallback) {
	var refreshToken = Cookies.get('refreshToken');
	if (refreshToken) {
		$.ajax({
type: "GET",
url: '//api.iotguru.live/credential/accessToken/' + refreshToken,
dataType: "text",
success: function (data) {
				if (typeof successCallback === "function") {
					successCallback(data);
				} else {
					credentialAccessTokenResponse(data);
				}
			},
error: function (xhr) {
				if (typeof errorCallback === "function") {
					errorCallback(xhr);
				} else {
					credentialAccessTokenError(xhr);
				}
			}
		});
	}
}

function credentialAccessTokenResponse(data) {
	Cookies.set('accessToken', data);
}

function credentialAccessTokenError(xhr) {
	alert('Cannot obtain access token, force logout...');
//	window.location = '/logout';
}


//================================================== credentialCheckToken ==============================================//

function credentialCheckToken(successCallback, errorCallback) {
	var accessToken = Cookies.get('accessToken');
	if (accessToken) {
		$.ajax({
type: "GET",
url: '//api.iotguru.live/credential/checkToken',
dataType: "text",
beforeSend: function (xhr) {
				xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
			},
success: function (data) {
				if (typeof successCallback === "function") {
					successCallback(data);
				} else {
					credentialCheckTokenResponse(data);
				}
			},
error: function (xhr) {
				if (typeof errorCallback === "function") {
					errorCallback(xhr);
				} else {
					credentialCheckTokenError(xhr);
				}
			}
		});
	}
}

function credentialCheckTokenResponse(data) {
	Cookies.set('userId', data);
}

function credentialCheckTokenError(xhr) {
	Cookies.remove('accessToken');
	Cookies.remove('userId');

	console.log('Cannot obtain check token, redirect to dashboard...');
//	window.location = '/';
}



//============================================== credentialRefreshToken =================================================//

function credentialRefreshToken(successCallback, errorCallback) {
	var UserEmail = 	'jeanluc@waurzyczka.fr';
	var UserPassword = 	'amjlamjl';
	$.ajax({
	type: "GET",
	url: '//api.iotguru.live/credential/refreshToken/' + UserEmail + '/' + UserPassword,
	dataType: "text",
	success: function (data) {
			if (typeof successCallback === "function") {
//				Cookies.set('refreshToken', data);
//				credentialAccessToken (false,false);
				successCallback(data);
			} else {
				credentialRefreshTokenResponse(data);
			}
		},
	error: function (xhr) {
			if (typeof errorCallback === "function") {
				errorCallback(xhr);
			} else {
				credentialRefreshTokenError(xhr);
			}
		}
	});
}


function credentialRefreshTokenResponse(data) {
	Cookies.set('refreshToken', data);
	credentialAccessToken (false,false);
}

function credentialRefreshTokenError(xhr) {
	alert('Cannot obtain access token, contact Jean-Luc Waurzyczka');
//	window.location = '/logout';
}



    
$(document).ready(function () {
	/*
1, /credential/refreshToken/{email}/{password} -> the result is a new refreshToken
2, /credential/accessToken/{refreshToken} -> the result is a new accessToken
3, /credential/checkToken -> check accessToken validity sent in header
*/

credentialRefreshToken(false, false);
//credentialAccessToken (false,false);
	deviceFind(DeviceShortId);
});

</script>
</div>
</body>
</html>
